<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>HeatmapGL - ECHARTS-GL</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- Fullscreen Landscape on iOS -->
    <link rel="stylesheet" href="./common.css" />
    <style>
      .wrapper {
        position: relative;
        height: 50vh;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div id="main"></div>
    </div>
    <script src="../node_modules/echarts/dist/echarts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/china.js"></script>
    <script src="../dist/echarts-gl.js"></script>
    <script src="lib/jquery.min.js"></script>
    <script src="js/commonUI.js"></script>
    <script>
      const main = document.getElementById("main");

      //──── Full screen ───────────────────────────────────────────────────────────────────────

      const toggleFullScreen = () => {
        console.log("toggle full screen");
        const isDocInFullScreenMode =
          document.fullscreenElement ||
          document["mozFullScreenElement"] ||
          document["webkitFullscreenElement"] ||
          document["msFullscreenElement"];

        if (isDocInFullScreenMode) {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document["webkitExitFullscreen"]) {
            /* Safari */
            document["webkitExitFullscreen"]();
          } else if (document["msExitFullscreen"]) {
            /* IE11 */
            document["msExitFullscreen"]();
          }
        } else {
          const target = main;
          if (target.requestFullscreen) {
            target.requestFullscreen();
          } else if (target["webkitRequestFullscreen"]) {
            /* Safari */
            target["webkitRequestFullscreen"]();
          } else if (target["msRequestFullscreen"]) {
            /* IE11 */
            target["msRequestFullscreen"]();
          }
        }
      };

      //──── Save as image ─────────────────────────────────────────────────────────────────────
      const onSaveAsImage = (document, imgSrc, name) => {
        const link = document.createElement("a");
        // link.setAttribute("src", imgSrc);
        link.setAttribute("target", "_blank");
        link.setAttribute("href", `${imgSrc}`);
        link.setAttribute("download", `${name}.png`);
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
      const saveAsImageConfig = {
        name: "COTU_ST_WL_OG215_LEVEL",
        show: false,
        icon: "M4.7,22.9L29.3,45.5L54.7,23.4M4.6,43.6L4.6,58L53.8,58L53.8,43.6M29.2,45.1L29.2,0",
        title: "save as image",
      };

      const onclickSaveBtn = () => {
        const chartBase64 = chart.getDataURL({
          excludeComponents: ["toolbox", "dataZoom"],
        });
        const chartImg = new Image();
        chartImg.src = chartBase64;

        // const glCanvas = document.getElementsByTagName("canvas")[1];
        // const glBase64 = glCanvas.toDataURL();
        // const glImg = new Image();
        // glImg.src = glBase64;

        const width = chart.getWidth();
        const height = chart.getHeight();
        const canvas = document.createElement("canvas");
        canvas.height = height;
        canvas.width = width;
        const ctx = canvas.getContext("2d");

        // const img = new Image();
        // img.src = imgBase64;
        chartImg.onload = function () {
          ctx.drawImage(chartImg, 0, 0, width, height);
          // ctx.drawImage(glImg, 0, 0, width, height);
          // ctx.font = "bold 20px Arial";
          // ctx.textAlign = "center";
          // ctx.fillStyle = "#808080";
          // ctx.fillText("Chart title", width / 2, 20);
          const dataURL = canvas.toDataURL();
          onSaveAsImage(document, dataURL, "fila name");
        };
      };

      var chart = echarts.init(document.getElementById("main"));

      //──── resize observer ───────────────────────────────────────────────────────────────────
      const resizeObserver = new ResizeObserver(() => {
        chart.resize();
      });

      resizeObserver.observe(main);

      chart.setOption({
        backgroundColor: "#fff",
        tooltip: {
          trigger: "item",
          formatter: "{c} C",
        },
        legend: {
          orient: "horizontal",
          x: "center",
          bottom: 45,
        },
        toolbox: {
          feature: {
            dataZoom: {
              title: {
                zoom: "zoom",
                back: "back",
              },
              yAxisIndex: "none",
            },
            saveAsImage: {
              name: "COTU_ST_WL_OG215_LEVEL",
              show: false,
              icon: "M4.7,22.9L29.3,45.5L54.7,23.4M4.6,43.6L4.6,58L53.8,58L53.8,43.6M29.2,45.1L29.2,0",
              title: "save as image",
            },
            mySaveAsImage: {
              name: "COTU_ST_WL_OG215_LEVEL",
              show: true,
              icon: "M4.7,22.9L29.3,45.5L54.7,23.4M4.6,43.6L4.6,58L53.8,58L53.8,43.6M29.2,45.1L29.2,0",
              title: "save as image",
              onclick: () => onclickSaveBtn(),
            },
            myFullscreen: {
              title: "fullscreen",
              icon: "M -7 -2 L -7 -7 M -7 -7 L -2 -7 M -7 2 L -7 7 M -2 7 L -7 7 M 2 7 L 7 7 M 7 2 L 7 7 M 7 -2 L 7 -7 M 2 -7 L 7 -7",
              show: true,
              onclick: () => toggleFullScreen(),
            },
          },
        },
        xAxis: {
          type: "category",
          min: "0%",
          max: "100%",
        },
        yAxis: {
          type: "category",
          name: "Y Axis name params",
          nameLocation: "center",
          nameGap: 30,
        },
        grid: {
          containLabel: true,
        },
        dataZoom: [
          {
            type: "inside",
            start: 0,
            end: 100,
          },
          {
            start: 0,
            end: 100,
            handleIcon:
              "M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z",
            handleSize: "80%",
            handleStyle: {
              color: "#fff",
              shadowBlur: 3,
              shadowColor: "rgba(0, 0, 0, 0.6)",
              shadowOffsetX: 2,
              shadowOffsetY: 2,
            },
          },
        ],
        series: [
          {
            name: "Punch Card",
            type: "heatmapGL",
            label: {
              show: true,
            },
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowColor: "rgba(0, 0, 0, 0.5)",
              },
            },
            data: [
              ["16th", "00", 9.738],
              ["16th", "01", 8.639],
              ["16th", "02", 3.696],
              ["16th", "03", 4.606],
              ["16th", "04", 6.307],
              ["16th", "05", 4.574],
              ["16th", "06", 6.49],
              ["16th", "07", 5.711],
              ["16th", "08", 1.909],
              ["16th", "09", 8.492],
              ["16th", "10", 2.402],
              ["17th", "00", 2.512],
              ["17th", "01", 5.593],
              ["17th", "02", 9.968],
              ["17th", "03", 9.345],
              ["17th", "04", 5.202],
              ["17th", "05", 1.651],
              ["17th", "06", 7.071],
              ["17th", "07", 6.872],
              ["17th", "08", 8.076],
              ["17th", "09", 3.001],
              ["17th", "10", 0.324],
              ["18th", "00", 7.789],
              ["18th", "01", 2.204],
              ["18th", "02", 2.732],
              ["18th", "03", 9.881],
              ["18th", "04", 6.862],
              ["18th", "05", 2.131],
              ["18th", "06", 2.567],
              ["18th", "07", 8.649],
              ["18th", "08", 2.673],
              ["18th", "09", 3.044],
              ["18th", "10", 4.831],
              ["19th", "00", 0.429],
              ["19th", "01", 3.743],
              ["19th", "02", 2.468],
              ["19th", "03", 7.813],
              ["19th", "04", 4.708],
              ["19th", "05", 3.187],
              ["19th", "06", 3.074],
              ["19th", "07", 1.31],
              ["19th", "08", 1.773],
              ["19th", "09", 0.002],
              ["19th", "10", 1.834],
            ],
          },
        ],
        visualMap: {
          min: 0,
          max: 10,
          calculable: true,
          orient: "vertical",
          right: "2%",
          top: "5%",
        },
        title: [
          {
            text: "Chart title",
            show: true,
            left: "center",
            top: 20,
          },
          // fix for saving images https://github.com/apache/echarts/issues/18470
          {
            id: "save-image-gl-fix",
            top: -5,
            left: -5,
            subtext: "fix echart-gl bug",
            subtextStyle: { color: "rgba(255, 0, 0, 0)" },
          },
        ],
      });
    </script>
    <!-- For debugging -->
    <!-- <script>
      document.addEventListener("click", (e) => {
        console.log("%cClick", "color: darkred", { x: e?.zrX, y: e?.zrY });
      });
    </script> -->
  </body>
</html>
